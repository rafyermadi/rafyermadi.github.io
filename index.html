<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rafy Rayyan — Blog & Novel</title>
  <meta name="description" content="Blog & arsip progres novel oleh Rafy Rayyan. Berbagi tulisan, ide, dan catatan proses."/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1117; --bg-soft:#151826; --card:#181c2e; --text:#e6e8ef; --muted:#96a0b5;
      --brand:#8b5cf6; --brand-2:#22d3ee; --ring:#3b82f6; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
      --maxw:1200px; --nav-h:72px;
    }
    html[data-theme="light"]{ --bg:#f7f8fc; --bg-soft:#fff; --card:#fff; --text:#101321; --muted:#5a6275; --ring:#2563eb }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:
      radial-gradient(1200px 600px at 10% -10%, rgba(139,92,246,.22), transparent 60%),
      radial-gradient(900px 500px at 110% 10%, rgba(34,211,238,.16), transparent 60%),
      linear-gradient(180deg, var(--bg), var(--bg));
      color:var(--text); font-family:"Plus Jakarta Sans",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; scroll-behavior:smooth}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}
    .container{max-width:var(--maxw);margin-inline:auto;padding-inline:20px}
    /* NAVBAR */
    .nav{position:sticky; top:0; z-index:70; min-height:var(--nav-h); padding-block:10px; backdrop-filter:blur(8px);
      background:color-mix(in oklab, var(--bg) 80%, #000 20%); border-bottom:1px solid rgba(255,255,255,.06)}
    html[data-theme="light"] .nav{border-bottom:1px solid rgba(16,19,33,.08)}
    .nav-inner{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.2px;flex:0 0 auto}
    .brand-badge{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;box-shadow:var(--shadow)}
    .menu{display:flex;gap:8px;align-items:center;flex:1 1 auto;min-width:0;overflow:auto;scrollbar-width:none}
    .menu::-webkit-scrollbar{display:none}
    .menu a{padding:10px 14px;border-radius:12px;color:var(--muted);white-space:nowrap}
    .menu a.active,.menu a:hover{color:var(--text);background:rgba(255,255,255,.06)}
    html[data-theme="light"] .menu a.active,html[data-theme="light"] .menu a:hover{background:rgba(16,19,33,.06)}
    .right-actions{display:flex;gap:10px;align-items:center;flex:0 0 auto}
    .toggle{padding:9px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);cursor:pointer}
    html[data-theme="light"] .toggle{border-color:rgba(16,19,33,.12);background:rgba(16,19,33,.04)}

    /* SHARED */
    .section{padding:28px 0 80px}
    .hidden{display:none !important}
    .visually-hidden{position:absolute !important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}

    /* HOME */
    .hero{padding:60px 0 32px}
    .hero-wrap{display:grid;grid-template-columns:160px 1fr;gap:24px;align-items:center}
    .avatar{width:160px;height:160px;border-radius:999px;overflow:hidden;position:relative;box-shadow:0 12px 30px rgba(0,0,0,.45)}
    .avatar::before{content:"";position:absolute;inset:-3px;border-radius:999px;padding:3px;background:linear-gradient(135deg,var(--brand),transparent 45%,var(--brand-2));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude}
    .hero h1{margin:0;font-family:"Playfair Display",serif;font-weight:600;font-size:42px;letter-spacing:.2px}
    .hero p{margin:10px 0 0;color:var(--muted);max-width:70ch;line-height:1.65}
    .hero-cta{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border:none}
    .toolbar{position:sticky;top:calc(var(--nav-h) - 1px);z-index:65;background:color-mix(in oklab,var(--bg) 85%,#000 15%);backdrop-filter:blur(8px);border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06)}
    html[data-theme="light"] .toolbar{border-color:rgba(16,19,33,.08)}
    .toolbar-inner{display:flex;gap:10px;align-items:center;padding:12px 0}
    .search{flex:1;display:flex;align-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;overflow:hidden}
    html[data-theme="light"] .search{background:rgba(16,19,33,.04);border-color:rgba(16,19,33,.12)}
    .search input{flex:1;padding:12px 14px;background:transparent;border:none;outline:none;color:var(--text)}
    .search .kbd{padding:0 10px;color:var(--muted);border-left:1px solid rgba(255,255,255,.08)}

    .grid{display:grid;gap:18px;grid-template-columns:repeat(3,1fr)}
    @media (max-width:1024px){.grid{grid-template-columns:repeat(2,1fr)}.hero-wrap{grid-template-columns:140px 1fr;align-items:start}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}.hero{padding:36px 0 14px}.hero-wrap{grid-template-columns:1fr;text-align:center;gap:14px}.avatar{margin-inline:auto}.hero-cta{justify-content:center}.nav-inner{flex-wrap:nowrap}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:20px;overflow:hidden;transition:transform .2s ease,box-shadow .2s ease;display:flex;flex-direction:column;min-height:380px}
    html[data-theme="light"] .card{border-color:rgba(16,19,33,.08)}
    .card:hover{transform:translateY(-4px);box-shadow:0 16px 40px rgba(0,0,0,.2)}
    .thumb{aspect-ratio:16/9;background:#0b0d13;overflow:hidden;position:relative}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .card-body{padding:14px;display:flex;flex-direction:column;gap:6px;flex:1}
    .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:13px}
    .title{margin:6px 0 8px;font-weight:700;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .card-body p{color:var(--muted);margin:0 0 8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:auto}
    .tag{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:#c9d3f0}

    /* ABOUT + POST */
    .about{padding:60px 0}
    .about-grid{display:grid;grid-template-columns:160px 1fr;gap:24px;align-items:start}
    @media (max-width:900px){.about-grid{grid-template-columns:1fr}}
    header.post{padding:30px 0}
    .post-title{font-family:"Playfair Display",serif;font-size:40px;margin:0 0 8px}
    .post-meta{color:var(--muted);font-size:14px}
    .post-hero{margin:18px 0;border-radius:20px;overflow:hidden;box-shadow:var(--shadow);display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,.08)}
    .post-hero img{display:block;max-width:100%;max-height:min(420px,60vh);height:auto;width:auto;object-fit:contain;margin-inline:auto}
    article{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:20px;line-height:1.85}
    article h2{font-size:24px;margin-top:28px}
    article blockquote{margin:16px 0;padding:8px 14px;border-left:3px solid var(--brand);background:rgba(255,255,255,.05);border-radius:8px}

    .post-nav{display:flex;justify-content:space-between;gap:10px;margin:22px 0}

    /* REACTIONS */
    .react-row{display:flex;gap:10px;align-items:center;margin:10px 0 4px}
    .rx{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);border-radius:999px;cursor:pointer;user-select:none}
    .rx[data-on="true"]{outline:2px solid color-mix(in oklab, var(--brand) 50%, transparent)}
    .rx .n{font-size:12px;color:var(--muted)}

    /* COMMENTS */
    #comments{margin:26px 0 60px}
    #cForm .row{display:flex;gap:8px;margin:8px 0}
    #cForm input, #cForm textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:transparent;color:var(--text)}
    #cForm textarea{min-height:80px;resize:vertical}
    #cList{display:flex;flex-direction:column;gap:10px;margin:12px 0}
    .cmt{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px}
    .cmt .by{color:var(--muted);font-size:12px;margin-bottom:4px}
    /* ensure our comment cards are NOT affected by .card min-height */
    #cList .card{min-height:auto}

    /* FOOTER */
    .site-footer{position:relative;border-top:1px solid rgba(255,255,255,.08);padding:50px 0 24px;color:var(--muted);overflow:hidden;background:
      radial-gradient(600px 200px at 10% -10%, rgba(139,92,246,.18), transparent 60%),
      radial-gradient(600px 200px at 110% 10%, rgba(34,211,238,.12), transparent 60%)}
    .foot-grid{display:grid;grid-template-columns:2fr 1fr 1fr;gap:20px}
    @media (max-width:800px){.foot-grid{grid-template-columns:1fr}}
    .iconbtn{display:inline-grid;place-items:center;width:36px;height:36px;border-radius:10px;border:1px solid rgba(255,255,255,.12)}

    /* Animations & helpers */
    :root{--ease:cubic-bezier(.22,1,.36,1)}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loader{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);backdrop-filter:blur(4px);z-index:140}
    .loader.show{display:grid}
    .loader .spinner{width:56px;height:56px;border-radius:50%;background:conic-gradient(from 0deg,var(--brand),var(--brand-2),var(--brand));mask:radial-gradient(farthest-side,transparent calc(50% - 6px),#000 0);animation:spin 1s linear infinite}
    .bgm-btn{position:fixed !important;right:max(16px,env(safe-area-inset-right));bottom:max(16px,env(safe-area-inset-bottom));z-index:200}
    .bgm-toast{position:fixed;right:max(70px,calc(env(safe-area-inset-right) + 70px));bottom:max(22px,calc(env(safe-area-inset-bottom) + 22px));z-index:201;background:color-mix(in oklab,var(--bg) 85%,#000 15%);color:var(--text);border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:12px;box-shadow:var(--shadow);font-size:14px;opacity:0;transform:translateY(6px);animation:toastIn .25s var(--ease) forwards}
    @keyframes toastIn{to{opacity:1;transform:none}}
  </style>
</head>
<body>
  <div id="loader" class="loader" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);z-index:120"><div class="spinner" style="width:48px;height:48px;border-radius:50%;border:4px solid rgba(255,255,255,.25);border-top-color:var(--brand-2);animation:spin 1s linear infinite" aria-label="Memuat"></div></div>
  <nav class="nav"><div class="container nav-inner">
    <a href="#/" class="brand" id="brand"><span class="brand-badge" aria-hidden="true"><span>R</span></span>Rafy Rayyan</a>
    <div class="menu" role="navigation" aria-label="Primary">
      <a href="#/" data-link="home" class="active">Beranda</a>
      <a href="#/blog" data-link="blog">Blog</a>
      <a href="#/novel" data-link="novel">Novel</a>
      <a href="#/about" data-link="about">About</a>
    </div>
    <div class="right-actions">
      <button id="themeToggle" class="toggle" aria-pressed="false" title="Ganti tema"><span id="themeIcon" aria-hidden="true">🌙</span></button>
    </div>
  </div></nav>

  <!-- HOME -->
  <div id="view-home">
    <header class="hero" id="top"><div class="container hero-wrap">
      <div class="avatar"><img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?q=80&w=800&auto=format&fit=crop" alt="Foto profil Rafy"/></div>
      <div>
        <h1>Halo, aku <span style="background:linear-gradient(135deg,var(--brand),var(--brand-2));-webkit-background-clip:text;background-clip:text;color:transparent">Rafy Rayyan</span>.</h1>
        <p>Ini adalah rumah digital untuk tugas akhir Bahasa Indonesia kelas 12 sekaligus blog pribadiku…</p>
        <div class="hero-cta"><button class="btn primary" id="openSub">Berlangganan via Email</button></div>
      </div>
    </div></header>
    <div class="toolbar" aria-label="Pencarian"><div class="container toolbar-inner">
      <label class="visually-hidden" for="search-home">Cari postingan</label>
      <div class="search"><input id="search-home" type="search" placeholder="Cari judul, tag, atau isi…" autocomplete="off"/><div class="kbd">/</div></div>
    </div></div>
    <main class="section container" aria-live="polite"><div class="grid" id="grid-home"></div><div class="pager" id="pager-home"></div></main>
  </div>

  <!-- BLOG -->
  <div id="view-blog" class="hidden"><section class="about" style="padding:40px 0 10px"><div class="container"><h1 style="font-family:'Playfair Display',serif;margin:0">Blog</h1><p style="color:var(--muted)">Tulisan selain progres novel.</p></div></section>
    <div class="toolbar" aria-label="Pencarian"><div class="container toolbar-inner"><label class="visually-hidden" for="search-blog">Cari postingan blog</label><div class="search"><input id="search-blog" type="search" placeholder="Cari di Blog…" autocomplete="off"/><div class="kbd">/</div></div></div></div>
    <main class="section container" aria-live="polite"><div class="grid" id="grid-blog"></div><div class="pager" id="pager-blog"></div></main>
  </div>

  <!-- NOVEL -->
  <div id="view-novel" class="hidden"><section class="about" style="padding:40px 0 10px"><div class="container"><h1 style="font-family:'Playfair Display',serif;margin:0">Novel</h1><p style="color:var(--muted)">Kumpulan bab, outline, dan catatan riset.</p></div></section>
    <div class="toolbar" aria-label="Pencarian"><div class="container toolbar-inner"><label class="visually-hidden" for="search-novel">Cari postingan novel</label><div class="search"><input id="search-novel" type="search" placeholder="Cari di Novel…" autocomplete="off"/><div class="kbd">/</div></div></div></div>
    <main class="section container" aria-live="polite"><div class="grid" id="grid-novel"></div><div class="pager" id="pager-novel"></div></main>
  </div>

  <!-- ABOUT -->
  <div id="view-about" class="hidden"><section class="about"><div class="container about-grid">
    <div class="avatar"><img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?q=80&w=800&auto=format&fit=crop" alt="Foto Rafy"></div>
    <div><h1 style="font-family:'Playfair Display',serif;font-size:40px;margin:0 0 8px">Tentang Penulis</h1><p style="color:var(--muted);line-height:1.8">Hai! Aku <strong>Rafy Rayyan</strong>…</p></div>
  </div></section></div>

  <!-- POST VIEW -->
  <div id="view-post" class="hidden">
    <header class="post"><div class="container">
      <h1 id="postTitle" class="post-title">Judul</h1>
      <div id="postMeta" class="post-meta">Tanggal • Tag</div>
      <div id="postHero" class="post-hero hidden"><img alt=""></div>
    </div></header>
    <main class="container">
      <article id="postBody"></article>
      <div class="react-row" id="reactRow" aria-label="Reaksi pembaca"></div>
      <nav class="post-nav"><a id="prevPost" class="btn" href="#">← Sebelumnya</a><a id="nextPost" class="btn" href="#">Berikutnya →</a></nav>

      <section id="comments">
        <h2>Komentar</h2>
        <!-- Form di ATAS, daftar di BAWAH (urutan terbaru → lama) -->
        <form id="cForm" autocomplete="off">
          <div class="row"><input id="cName" placeholder="Nama (opsional)"><input id="cPhoto" placeholder="URL foto profil (opsional)"></div>
          <div class="row"><textarea id="cText" placeholder="Tulis komentar…"></textarea></div>
          <div class="row" style="justify-content:flex-end"><button type="button" id="cClear" class="btn">Bersihkan</button><button type="submit" class="btn primary">Kirim</button></div>
        </form>
        <div id="cList"></div>
      </section>
    </main>
  </div>

  <footer class="site-footer"><div class="container foot-grid">
    <div><div class="brand-badge"></div><div class="desc">Blog ini mendokumentasikan perjalanan menulis novel…</div></div>
    <div><div style="font-weight:700;margin-bottom:8px">Stat singkat</div><div class="stat"><div class="box"><div style="font-size:28px;font-weight:800" id="statPosts">0</div><div style="font-size:12px;color:var(--muted)">Total Post</div></div><div class="box"><div style="font-size:28px;font-weight:800" id="statTags">0</div><div style="font-size:12px;color:var(--muted)">Jumlah Tag</div></div></div></div>
    <div><div style="font-weight:700;margin-bottom:8px">Catatan kecil</div><div class="quote">“Menulis itu merawat ingatan…”</div></div>
  </div><div class="container" style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:18px"><span>© 2025 — Rafy Rayyan</span><button class="btn" id="toTop" type="button">Kembali ke atas</button></div></footer>

  <!-- LOADER (global) -->
  <div id="page-loader" class="loader" aria-hidden="true"><div class="spinner" role="status" aria-label="Memuat"></div></div>

  <!-- BGM -->
  <audio id="bgm" loop preload="auto"></audio>
  <button id="bgmToggle" class="bgm-btn" aria-pressed="false" title="Musik latar"><span class="bgm-ico" aria-hidden="true">🔇</span><span class="visually-hidden">Toggle musik latar</span></button>

  <script>
  // ===== UTIL =====
  const $ = (s, el=document)=> el.querySelector(s);
  const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));
  const root = document.documentElement;
  function setTheme(t){ root.setAttribute('data-theme',t); localStorage.setItem('theme',t); const ic=$('#themeIcon'); if(ic){ ic.textContent=t==='light'?'☀️':'🌙'; } $('#themeToggle').setAttribute('aria-pressed', t==='dark'?'true':'false'); }
  setTheme(localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark'));
  $('#themeToggle').addEventListener('click', ()=> setTheme(root.getAttribute('data-theme')==='dark'?'light':'dark'));
  const monthID=['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  const fmtDate = iso=>{ const d=new Date(iso+'T00:00:00'); return `${d.getDate()} ${monthID[d.getMonth()]} ${d.getFullYear()}` };

  // ===== DATA (DEMO POSTS) — silakan ganti/lanjutkan data yang sudah kamu punya =====
  const posts=[
    { id:'novel-bab-1', title:'Novel — Bab 1: Pagi yang Menggantung', date:'2025-08-20', tags:['Novel','Progres','Bab 1'], image:'https://images.unsplash.com/photo-1507842217343-583bb7270b66?q=80&w=1200&auto=format&fit=crop', excerpt:'Awal cerita…', body:`<p>Pagi di Jakarta…</p><h2>Set up konflik</h2><p>…</p>`},
    { id:'catatan-riset', title:'Catatan Riset: Menentukan Setting & Perspektif', date:'2025-08-18', tags:['Novel','Catatan','Riset'], image:'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop', excerpt:'Kenapa memilih POV…', body:`<p>Aku membandingkan…</p>`},
    { id:'teknik-dialog', title:'Teknik Dialog: Biar Ngobrolnya Hidup', date:'2025-08-16', tags:['Tips Menulis','Workshop','Blog'], image:'https://images.unsplash.com/photo-1515516969-d4008cc6241a?q=80&w=1200&auto=format&fit=crop', excerpt:'Trik sederhana…', body:`<p>Trik cepat…</p>`},
    // … tambahkan kembali semua 13 post milikmu di sini (dipersingkat di contoh ini)
  ];

  const states={home:{q:'',page:1}, blog:{q:'',page:1}, novel:{q:'',page:1}};
  const norm=s=>(s||'').toLowerCase().replace(/<[^>]+>/g,' ');
  function cardHTML(p){return `<a class="card-link" href="#/post/${encodeURIComponent(p.id)}" aria-label="Buka: ${p.title}"><article class="card"><div class="thumb">${p.image?`<img src="${p.image}" alt="Thumbnail ${p.title}">`:''}</div><div class="card-body"><div class="meta"><span>${fmtDate(p.date)}</span>•<span>${p.tags[0]}</span></div><h3 class="title">${p.title}</h3><p>${p.excerpt}</p><div class="tags">${p.tags.map(t=>`<span class="tag">#${t}</span>`).join('')}</div></div></article></a>`}
  function searchFilter(list,q){const t=q.trim()?q.trim().toLowerCase().split(/\s+/):[];let res=list; if(t.length){res=res.filter(p=>{const hay=norm(p.title+' '+p.excerpt+' '+p.tags.join(' ')+' '+p.body);return t.every(x=>hay.includes(x));});} return res.sort((a,b)=> new Date(b.date)-new Date(a.date));}
  function perPage(){return innerWidth<640?8:(innerWidth<=1024?8:12)}
  function renderGrid(gridEl,list){const fbk=`<div style="grid-column:1/-1;padding:26px;border:1px dashed rgba(255,255,255,.18);border-radius:14px;text-align:center;color:var(--muted)">Tidak ada hasil yang cocok.</div>`; gridEl.innerHTML=list.length?list.map(cardHTML).join(''):fbk}
  function renderPager(view,total){const wrap=$(`#pager-${view}`); if(!wrap) return; const cur=states[view].page; if(total<=1){wrap.innerHTML='';return} const nums=[]; const push=n=>nums.push(`<button class="btn ${n===cur?'active':''}" data-p="${n}">${n}</button>`); const dots=()=>nums.push(`<span style="padding:8px 6px;color:var(--muted)">…</span>`); push(1); if(cur>3)dots(); for(let n=Math.max(2,cur-1); n<=Math.min(total-1,cur+1); n++) push(n); if(cur<total-2)dots(); if(total>1)push(total); wrap.innerHTML=`<button class="btn" data-p="prev" ${cur===1?'disabled':''}>←</button>${nums.join('')}<button class="btn" data-p="next" ${cur===total?'disabled':''}>→</button>`; wrap.onclick=e=>{const p=e.target.getAttribute('data-p'); if(!p)return; if(p==='prev'&&states[view].page>1)states[view].page--; else if(p==='next'&&states[view].page<total)states[view].page++; else if(/^\d+$/.test(p))states[view].page=parseInt(p,10); routeRender(); window.scrollTo({top:0,behavior:'smooth'});}; }
  function setupSearch(view){const S=states[view]; const input=document.getElementById(`search-${view}`); if(!input||input.dataset.inited)return; input.dataset.inited='1'; window.addEventListener('keydown',e=>{if(document.getElementById(`view-${view}`).classList.contains('hidden'))return; if(e.key==='/'&&document.activeElement!==input){e.preventDefault(); input.focus();}}); input.addEventListener('input',e=>{S.q=e.target.value; S.page=1; routeRender();});}
  function renderHome(){setupSearch('home'); const f=searchFilter(posts.slice(),states.home.q); const per=perPage(); const total=Math.max(1,Math.ceil(f.length/per)); states.home.page=Math.min(Math.max(1,states.home.page),total); const start=(states.home.page-1)*per; renderGrid($('#grid-home'), f.slice(start,start+per)); renderPager('home', total)}
  function renderBlog(){setupSearch('blog'); const base=posts.filter(p=>p.tags.includes('Blog')); const f=searchFilter(base,states.blog.q); const per=perPage(); const total=Math.max(1,Math.ceil(f.length/per)); states.blog.page=Math.min(Math.max(1,states.blog.page),total); const start=(states.blog.page-1)*per; renderGrid($('#grid-blog'), f.slice(start,start+per)); renderPager('blog', total)}
  function renderNovel(){setupSearch('novel'); const base=posts.filter(p=>p.tags.includes('Novel')); const f=searchFilter(base,states.novel.q); const per=perPage(); const total=Math.max(1,Math.ceil(f.length/per)); states.novel.page=Math.min(Math.max(1,states.novel.page),total); const start=(states.novel.page-1)*per; renderGrid($('#grid-novel'), f.slice(start,start+per)); renderPager('novel', total)}
  function renderPost(id){const idx=posts.findIndex(p=>p.id===id); const post=posts[idx]||posts[0]; document.title=post.title+' — Rafy Rayyan'; $('#postTitle').textContent=post.title; $('#postMeta').textContent=fmtDate(post.date)+' • '+post.tags.join(', '); const hero=$('#postHero'); if(post.image){hero.classList.remove('hidden'); const img=hero.firstElementChild; img.src=post.image; img.alt='Gambar: '+post.title;} else hero.classList.add('hidden'); $('#postBody').innerHTML=post.body; const prev=posts[idx-1]||null, next=posts[idx+1]||null; const prevA=$('#prevPost'), nextA=$('#nextPost'); if(prev){prevA.href=`#/post/${prev.id}`; prevA.textContent='← '+prev.title; prevA.style.visibility='visible';} else prevA.style.visibility='hidden'; if(next){nextA.href=`#/post/${next.id}`; nextA.textContent=next.title+' →'; nextA.style.visibility='visible';} else nextA.style.visibility='hidden'; setupReactions(post.id); loadComments(post.id); }
  function setActive(h){$$('.menu a').forEach(a=>{const k=a.dataset.link; const on=(k==='home'&&(h==='#/'||h===''||h==='#'))||(k==='about'&&h.startsWith('#/about'))||(k==='blog'&&h.startsWith('#/blog'))||(k==='novel'&&h.startsWith('#/novel')); a.classList.toggle('active',on);});}
  function show(v){$('#view-home').classList.toggle('hidden',v!=='home'); $('#view-about').classList.toggle('hidden',v!=='about'); $('#view-post').classList.toggle('hidden',v!=='post'); $('#view-blog').classList.toggle('hidden',v!=='blog'); $('#view-novel').classList.toggle('hidden',v!=='novel'); window.scrollTo({top:0,behavior:'auto'})}
  function showLoader(){ $('#page-loader')?.classList.add('show'); } function hideLoader(){ $('#page-loader')?.classList.remove('show'); }
  function routeRender(){const h=location.hash||'#/' ; setActive(h); showLoader(); const done=()=>setTimeout(hideLoader,200); if(h.startsWith('#/post/')){show('post'); renderPost(decodeURIComponent(h.replace('#/post/',''))); done();} else if(h==='#/about'){show('about'); done();} else if(h==='#/blog'){show('blog'); renderBlog(); done();} else if(h==='#/novel'){show('novel'); renderNovel(); done();} else {show('home'); renderHome(); done();}}
  window.addEventListener('hashchange', routeRender);
  $('#statPosts').textContent=posts.length; $('#statTags').textContent=new Set(posts.flatMap(p=>p.tags)).size;
  $('#toTop').addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'}));

  // ===== FIREBASE (v10.12.x) =====
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, deleteDoc, addDoc, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ---- Ganti dengan milikmu (punya kamu sudah pernah kirim) ----
    const firebaseConfig = {
      apiKey: "AIzaSyA0Nc3sCYCfhsX6y6Ft5SxEuZDBcfT0zHk",
      authDomain: "rafyermadi-a4e98.firebaseapp.com",
      projectId: "rafyermadi-a4e98",
      storageBucket: "rafyermadi-a4e98.firebasestorage.app",
      messagingSenderId: "529097759816",
      appId: "1:529097759816:web:7c0081bf4b612b2dee4c7d"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    console.log('Firebase ready');

    // ===== DEVICE ID (local) =====
    function getDeviceId(){ try{ let id=localStorage.getItem('deviceId'); if(!id){ id=crypto.randomUUID(); localStorage.setItem('deviceId', id); } return id;}catch(e){ return 'anon-'+Math.random().toString(36).slice(2);} }

    // ===== REACTIONS =====
    const REACTS=['up','love','fire','clap','wow'];
    const EMOJI={up:'👍', love:'❤️', fire:'🔥', clap:'👏', wow:'😯'};

    async function readCounts(postId){
      const snap = await getDocs(collection(db, `posts/${postId}/reactions`));
      const sum = { up:0, love:0, fire:0, clap:0, wow:0 };
      snap.forEach(d=>{ const v=d.data(); REACTS.forEach(k=>{ if(v[k]) sum[k]++; }); });
      return sum;
    }

    async function readMine(postId){
      const ref = doc(db, `posts/${postId}/reactions/${getDeviceId()}`);
      const s = await getDoc(ref);
      return s.exists()? s.data() : {};
    }

    function renderRow(postId, counts, mine){
      const wrap = document.getElementById('reactRow');
      wrap.innerHTML = REACTS.map(k=>{
        const on = !!mine[k];
        return `<button class="rx" data-k="${k}" data-on="${on}"><span class="e">${EMOJI[k]}</span><span class="n">${counts[k]}</span></button>`;
      }).join('');

      wrap.onclick = async (e)=>{
        const btn = e.target.closest('.rx'); if(!btn) return;
        const k = btn.getAttribute('data-k');
        try {
          const deviceId = getDeviceId();
          const ref = doc(db, `posts/${postId}/reactions/${deviceId}`);
          const snap = await getDoc(ref);
          const cur = snap.exists()? snap.data() : { deviceId };
          const nextOn = !cur[k];
          const next = { deviceId, [k]: nextOn, updatedAt: serverTimestamp() };
          // merge value
          await setDoc(ref, next, { merge: true });
          // if setelah toggle semua false → hapus
          const after = { ...cur, ...next };
          const allOff = REACTS.every(x => !after[x]);
          if(allOff) await deleteDoc(ref);
          // refresh UI
          const [c2,m2] = await Promise.all([readCounts(postId), readMine(postId)]);
          renderRow(postId, c2, m2);
        } catch(err){
          console.error(err);
          alert('Gagal menyimpan reaction.');
        }
      };
    }

    async function setupReactions(postId){
      try{
        const [counts, mine] = await Promise.all([readCounts(postId), readMine(postId)]);
        renderRow(postId, counts, mine);
      }catch(err){ console.error(err); }
    }

    // ===== COMMENTS (form atas, daftar terbaru → lama) =====
    async function loadComments(postId){
      const qy = query(collection(db, `posts/${postId}/comments`), orderBy('createdAt','desc'), limit(100));
      const snap = await getDocs(qy);
      const list = document.getElementById('cList');
      list.innerHTML = '';
      snap.forEach(d=>{
        const v=d.data();
        const name = (v.name||'anon');
        const t = v.createdAt?.toDate? v.createdAt.toDate() : null;
        const when = t? `${String(t.getDate()).padStart(2,'0')} ${monthID[t.getMonth()]} ${t.getFullYear()}, ${String(t.getHours()).padStart(2,'0')}.${String(t.getMinutes()).padStart(2,'0')}` : '';
        const card = document.createElement('div');
        card.className='cmt';
        card.innerHTML = `<div class="by">${name} • ${when}</div><div>${(v.text||'').replace(/</g,'&lt;')}</div>`;
        list.appendChild(card);
      });

      // Hook form (once)
      const form = document.getElementById('cForm');
      if(form.dataset.inited) return; form.dataset.inited='1';
      document.getElementById('cClear').onclick=()=>{ document.getElementById('cText').value=''; };
      form.addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const name = document.getElementById('cName').value.trim();
        const photo = document.getElementById('cPhoto').value.trim();
        const text = document.getElementById('cText').value.trim();
        if(!text) return;
        try{
          await addDoc(collection(db, `posts/${postId}/comments`), { name, photo, text, createdAt: serverTimestamp() });
          document.getElementById('cText').value='';
          await loadComments(postId); // refresh
        }catch(err){ console.error(err); alert('Gagal mengirim komentar.'); }
      });
    }

    // ===== boot router =====
    routeRender();
    window.addEventListener('load', ()=>{ const l=document.getElementById('loader'); if(l) l.classList.add('hidden'); });
  </script>

  <!-- BGM scripts (ringkas) -->
  <script>
    (function(){
      const MUSIC_SRC = 'bgm.mp3';
      const bgm=$('#bgm'), btn=$('#bgmToggle'), ico=btn.querySelector('.bgm-ico');
      bgm.src=MUSIC_SRC; bgm.loop=true; bgm.preload='auto';
      function ui(){ const p=!bgm.paused&&!bgm.ended; btn.setAttribute('aria-pressed', p?'true':'false'); ico.textContent=p?'🔊':'🔇'; }
      async function play(){ try{ await bgm.play(); localStorage.setItem('bgm','on'); }catch(e){ localStorage.setItem('bgm','off'); } finally{ ui(); } }
      if(localStorage.getItem('bgm')==='on') play(); else ui();
      btn.addEventListener('click', ()=>{ if(bgm.paused) play(); else {bgm.pause(); localStorage.setItem('bgm','off'); ui();} });
    })();
  </script>

</body>
</html>
