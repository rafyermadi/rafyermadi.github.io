<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="google-site-verification" content="dE4TfcsipsPALHJNwGjgza_DuGgxRaK-VzpxvuxWDt0" />
  <title>Rafy Rayyan — Blog & Novel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600..800&family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0f1117;        /* dark */
      --bg-soft: #151826;
      --card: #181c2e;
      --text: #e6e8ef;
      --muted: #96a0b5;
      --brand: #8b5cf6; /* violet-500 */
      --brand-2: #22d3ee; /* cyan-400 */
      --ring: #3b82f6; /* blue-500 */
      --radius: 16px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --maxw: 1200px;
      --nav-h: 72px;
      --ease: cubic-bezier(.22,1,.36,1);
    }
    html[data-theme="light"]{
      --bg: #f7f8fc;       /* light */
      --bg-soft: #ffffff;
      --card: #ffffff;
      --text: #101321;
      --muted: #5a6275;
      --ring: #2563eb;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:
      radial-gradient(1200px 600px at 10% -10%, rgba(139,92,246,.22), transparent 60%),
      radial-gradient(900px 500px at 110% 10%, rgba(34,211,238,.16), transparent 60%),
      linear-gradient(180deg, var(--bg), var(--bg));
      color:var(--text);
      font-family:"Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      scroll-behavior:smooth;
    }
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}
    .container{max-width:var(--maxw);margin-inline:auto;padding-inline:20px}

    /* NAVBAR */
    .nav{position:sticky; top:0; z-index:70; min-height:var(--nav-h); padding-block:10px;
      backdrop-filter: blur(8px);
      background: color-mix(in oklab, var(--bg) 80%, #000 20%);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    html[data-theme="light"] .nav{border-bottom:1px solid rgba(16,19,33,.08)}
    .nav-inner{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.2px;flex:0 0 auto}
    .brand-badge{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;box-shadow: var(--shadow)}
    .brand-badge span{font-weight:800}
    .menu{display:flex;gap:8px;align-items:center;flex:1 1 auto;min-width:0;overflow:auto;scrollbar-width:none}
    .menu::-webkit-scrollbar{display:none}
    .menu a{padding:10px 14px;border-radius:12px;color:var(--muted);white-space:nowrap}
    .menu a.active, .menu a:hover{color:var(--text);background:rgba(255,255,255,.06)}
    html[data-theme="light"] .menu a.active, html[data-theme="light"] .menu a:hover{background:rgba(16,19,33,.06)}
    .right-actions{display:flex;gap:10px;align-items:center;flex:0 0 auto}
    .toggle{padding:9px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);cursor:pointer}
    html[data-theme="light"] .toggle{border-color:rgba(16,19,33,.12);background:rgba(16,19,33,.04)}

    /* SHARED */
    .section{padding:28px 0 80px}
    .hidden{display:none !important}
    .visually-hidden{position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap;}

    /* HOME (HERO + TOOLBAR + GRID) */
    .hero{padding:60px 0 32px}
    .hero-wrap{display:grid;grid-template-columns:160px 1fr;gap:24px;align-items:center}
    .avatar{width:160px;height:160px;border-radius:999px;overflow:hidden;position:relative;box-shadow:0 12px 30px rgba(0,0,0,.45)}
    .avatar::before{content:"";position:absolute;inset:-3px;border-radius:999px;padding:3px;background:linear-gradient(135deg,var(--brand),transparent 45%, var(--brand-2)); -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite:xor; mask-composite:exclude}
    .hero h1{margin:0;font-family:"Playfair Display", serif;font-weight:600;font-size:42px;letter-spacing:.2px}
    .hero p{margin:10px 0 0;color:var(--muted);max-width:70ch;line-height:1.65}
    .hero-cta{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border:none}

    .toolbar{position:sticky; top:calc(var(--nav-h) - 1px); z-index:65; background:color-mix(in oklab, var(--bg) 85%, #000 15%);backdrop-filter: blur(8px);
      border-top:1px solid rgba(255,255,255,.06); border-bottom:1px solid rgba(255,255,255,.06)}
    html[data-theme="light"] .toolbar{border-color:rgba(16,19,33,.08)}
    .toolbar-inner{display:flex;gap:10px;align-items:center;padding:12px 0}
    .search{flex:1;display:flex;align-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;overflow:hidden}
    html[data-theme="light"] .search{background:rgba(16,19,33,.04);border-color:rgba(16,19,33,.12)}
    .search input{flex:1;padding:12px 14px;background:transparent;border:none;outline:none;color:var(--text)}
    .search .kbd{padding:0 10px;color:var(--muted);border-left:1px solid rgba(255,255,255,.08)}
    html[data-theme="light"] .search .kbd{border-left-color:rgba(16,19,33,.1)}

    .grid{display:grid;gap:18px;grid-template-columns:repeat(3, 1fr)}
    @media (max-width: 1024px){.grid{grid-template-columns:repeat(2,1fr)} .hero-wrap{grid-template-columns:140px 1fr;align-items:start}}
    @media (max-width: 640px){.grid{grid-template-columns:1fr} .hero{padding:36px 0 14px} .hero-wrap{grid-template-columns:1fr; text-align:center; gap:14px} .avatar{margin-inline:auto} .hero-cta{justify-content:center} .nav-inner{flex-wrap:nowrap}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:20px;overflow:hidden;transition:transform .2s ease, box-shadow .2s ease;display:flex;flex-direction:column;min-height:380px}
    html[data-theme="light"] .card{border-color:rgba(16,19,33,.08)}
    .card:hover{transform:translateY(-4px); box-shadow:0 16px 40px rgba(0,0,0,.2)}
    .thumb{aspect-ratio:16/9; background:#0b0d13; overflow:hidden; position:relative}
    html[data-theme="light"] .thumb{background:#e9ecf7}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .card-body{padding:14px;display:flex;flex-direction:column;gap:6px;flex:1}
    .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:13px}
    .title{margin:6px 0 8px;font-weight:700;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .card-body p{color:var(--muted);margin:0 0 8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:auto}
    .tag{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:#c9d3f0}
    html[data-theme="light"] .tag{color:#34406a;border-color:rgba(16,19,33,.12)}

    /* ABOUT VIEW */
    .about{padding:60px 0}
    .about-grid{display:grid;grid-template-columns:160px 1fr;gap:24px;align-items:start}
    @media (max-width:900px){.about-grid{grid-template-columns:1fr}}
    .about .card{border-radius:18px;padding:18px}

    /* POST VIEW */
    header.post{padding:30px 0}
    .post-title{font-family:"Playfair Display",serif;font-size:40px;margin:0 0 8px}
    .post-meta{color:var(--muted);font-size:14px}
    .post-hero{margin:18px 0;border-radius:20px;overflow:hidden;box-shadow:var(--shadow);display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,.08)}
    .post-hero img{display:block;max-width:100%;max-height:min(420px,60vh);height:auto;width:auto;object-fit:contain;margin-inline:auto}
    article{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:20px;line-height:1.85}
    article h2{font-size:24px;margin-top:28px}
    article p{margin:12px 0}
    article blockquote{margin:16px 0;padding:8px 14px;border-left:3px solid var(--brand);background:rgba(255,255,255,.05);border-radius:8px}
    article img{max-width:100%;height:auto;border-radius:12px;display:block;margin:10px auto}
    .post-nav{display:flex;justify-content:space-between;gap:10px;margin:22px 0}

    /* FOOTER — BIO STYLE */
    .site-footer{position:relative;border-top:1px solid rgba(255,255,255,.08);padding:50px 0 24px;color:var(--muted);overflow:hidden;background:
      radial-gradient(600px 200px at 10% -10%, rgba(139,92,246,.18), transparent 60%),
      radial-gradient(600px 200px at 110% 10%, rgba(34,211,238,.12), transparent 60%)}
    html[data-theme="light"] .site-footer{border-top-color:rgba(16,19,33,.08)}
    .foot-grid{display:grid;grid-template-columns:2fr 1fr 1fr;gap:20px}
    @media (max-width: 800px){.foot-grid{grid-template-columns:1fr}}
    .foot-brand{display:flex;gap:12px;align-items:center}
    .foot-brand .desc{color:var(--muted);max-width:60ch;line-height:1.7}
    .foot-social{display:flex;gap:10px;margin-top:10px}
    .iconbtn{display:inline-grid;place-items:center;width:36px;height:36px;border-radius:10px;border:1px solid rgba(255,255,255,.12)}
    html[data-theme="light"] .iconbtn{border-color:rgba(16,19,33,.12)}
    .stat{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .stat .box{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;text-align:center}
    .quote{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;font-style:italic}
    .copy{margin-top:18px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}

    /* PAGINATION */
    .pager{display:flex;gap:8px;justify-content:center;margin-top:16px;flex-wrap:wrap}
    .pager .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04)}
    html[data-theme="light"] .pager .btn{border-color:rgba(16,19,33,.12);background:rgba(16,19,33,.04)}
    .pager .btn[disabled]{opacity:.5;cursor:not-allowed}
    .pager .btn.active{background:linear-gradient(135deg,var(--brand),var(--brand-2));border:none;color:#fff}

    /* MODAL */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:120}
    .modal:not(.hidden){display:flex}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(3px)}
    .modal-card{position:relative;z-index:1;width:min(520px,92vw);background:var(--bg-soft);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px}
    .modal-card input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:transparent;color:var(--text)}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    /* Ensure JS hide wins over inline display */
    .loader.hidden{display:none !important}
    @keyframes fadeSlideUp{from{opacity:0;transform:translateY(16px) scale(.98)}to{opacity:1;transform:none}}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
    @keyframes spin{to{transform:rotate(360deg)}}

    .will-reveal{opacity:0;transform:translateY(16px) scale(.98)}
    .reveal-in{opacity:1;transform:none;transition:opacity .7s var(--ease), transform .7s var(--ease)}

    .card .thumb img{transition:transform .6s var(--ease)}
    .card:hover .thumb img{transform:scale(1.06)}

    .btn{transition:transform .2s var(--ease), box-shadow .2s var(--ease), background .2s var(--ease)}
    .btn:hover{box-shadow:0 10px 24px rgba(0,0,0,.25); transform:translateY(-1px)}
    .btn:active{transform:translateY(0) scale(.98)}

    .search input{transition:border-color .2s ease, box-shadow .2s ease}
    .search:focus-within{box-shadow:0 0 0 3px color-mix(in oklab, var(--ring) 40%, transparent)}

    .nav{transition:background .3s var(--ease), box-shadow .3s var(--ease), transform .3s var(--ease)}
    .nav.scrolled{box-shadow:0 12px 30px rgba(0,0,0,.35); background:color-mix(in oklab, var(--bg) 70%, #000 30%)}

    .loader{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.35); backdrop-filter:blur(4px); z-index:140}
    .loader.show{display:grid}
    .loader .spinner{width:56px;height:56px;border-radius:50%;background:conic-gradient(from 0deg, var(--brand), var(--brand-2), var(--brand));mask:radial-gradient(farthest-side, transparent calc(50% - 6px), #000 0);animation:spin 1s linear infinite}

    .thumb.skeleton::before{content:"";position:absolute;inset:0;background:linear-gradient(110deg, rgba(255,255,255,.06) 8%, rgba(255,255,255,.18) 18%, rgba(255,255,255,.06) 33%);background-size:200% 100%;animation:shimmer 1.2s linear infinite}

    @media (prefers-reduced-motion: reduce){*{animation:none !important; transition:none !important}}

    /* Force-fixed position override for background music button */
    .bgm-btn{position:fixed !important; right:max(16px, env(safe-area-inset-right)); bottom:max(16px, env(safe-area-inset-bottom)); z-index:200}

    /* === BGM Toast (one-time prompt when autoplay blocked) === */
    .bgm-toast{position:fixed; right:max(70px, calc(env(safe-area-inset-right) + 70px)); bottom:max(22px, calc(env(safe-area-inset-bottom) + 22px)); z-index:201; background:color-mix(in oklab, var(--bg) 85%, #000 15%); color:var(--text); border:1px solid rgba(255,255,255,.12); padding:8px 12px; border-radius:12px; box-shadow: var(--shadow); font-size:14px; opacity:0; transform: translateY(6px); animation: toastIn .25s var(--ease) forwards}
    html[data-theme="light"] .bgm-toast{border-color: rgba(16,19,33,.12); background: rgba(16,19,33,.92)}
    @keyframes toastIn{to{opacity:1; transform:none}}

    /* Reactions & comments */
    .react-row{display:flex;gap:10px;align-items:center;margin:10px 0 18px}
    .react-btn{display:inline-flex;gap:6px;align-items:center;padding:6px 9px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);cursor:pointer;font-size:14px}
    .react-btn[disabled]{opacity:.6;cursor:not-allowed}
    .react-btn.active{outline:2px solid color-mix(in oklab, var(--brand) 55%, transparent)}
    .cform{display:flex;flex-direction:column;gap:8px;margin:12px 0}
    .cform input,.cform textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:transparent;color:var(--text)}
    /* Batasi tinggi textarea komentar */
    .cform textarea{min-height:90px;max-height:220px;resize:vertical}
    #clist{display:flex;flex-direction:column;gap:10px;margin:12px 0}
    .card{position:relative}
    /* Override khusus kartu KOMENTAR */
    #comments .card, #cList .card{min-height:unset; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:transparent}
    .comment-card{padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:transparent}
  </style>
</head>
<body>
  <!-- Instant Loader (first paint) -->
  <div id="loader" class="loader" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);z-index:120">
    <div class="spinner" style="width:48px;height:48px;border-radius:50%;border:4px solid rgba(255,255,255,.25);border-top-color:var(--brand-2);animation:spin 1s linear infinite" aria-label="Memuat"></div>
  </div>

  <!-- NAVBAR -->
  <nav class="nav">
    <div class="container nav-inner">
      <a href="/" class="brand" id="brand"><span class="brand-badge" aria-hidden="true"><span>R</span></span>Rafy Rayyan</a>
      <div class="menu" role="navigation" aria-label="Primary">
        <a href="/" data-link="home" class="active">Beranda</a>
        <a href="/blog" data-link="blog">Blog</a>
        <a href="/novel" data-link="novel">Novel</a>
        <a href="/about" data-link="about">About</a>
      </div>
      <div class="right-actions">
        <button id="themeToggle" class="toggle" aria-pressed="false" title="Ganti tema"><span id="themeIcon" aria-hidden="true">🌙</span></button>
      </div>
    </div>
  </nav>

  <!-- HOME VIEW -->
  <div id="view-home">
    <header class="hero" id="top">
      <div class="container hero-wrap">
        <div class="avatar"><img src="rafyprofile.jpg" alt="Foto profil Rafy Rayyan"/></div>
        <div>
          <h1>Halo, aku <span style="background:linear-gradient(135deg,var(--brand),var(--brand-2));-webkit-background-clip:text;background-clip:text;color:transparent">Rafy Rayyan</span>.</h1>
          <p>Ini adalah rumah digital untuk tugas akhir Bahasa Indonesia kelas 12 sekaligus blog pribadiku. Di sini aku mengarsipkan progres <em>novel</em> yang sedang kutulis, juga catatan, opini, dan eksperimen lain. Selamat mampir! ✨</p>
          <div class="hero-cta"><button class="btn primary" id="openSub">Berlangganan via Email</button></div>
        </div>
      </div>
    </header>
    <div class="toolbar" aria-label="Pencarian">
      <div class="container toolbar-inner">
        <label class="visually-hidden" for="search-home">Cari postingan</label>
        <div class="search"><input id="search-home" type="search" placeholder="Cari judul, tag, atau isi… (ketik untuk memfilter)" autocomplete="off"/><div class="kbd">/</div></div>
      </div>
    </div>
    <main class="section container" aria-live="polite">
      <div class="grid" id="grid-home"></div>
      <div class="pager" id="pager-home"></div>
    </main>
  </div>

  <!-- BLOG VIEW -->
  <div id="view-blog" class="hidden">
    <section class="about" style="padding:40px 0 10px"><div class="container"><h1 style="font-family:'Playfair Display',serif;margin:0">Blog</h1><p style="color:var(--muted)">Tulisan-tulisan selain progres novel.</p></div></section>
    <div class="toolbar" aria-label="Pencarian"><div class="container toolbar-inner"><label class="visually-hidden" for="search-blog">Cari postingan blog</label><div class="search"><input id="search-blog" type="search" placeholder="Cari di Blog…" autocomplete="off"/><div class="kbd">/</div></div></div></div>
    <main class="section container" aria-live="polite"><div class="grid" id="grid-blog"></div><div class="pager" id="pager-blog"></div></main>
  </div>

  <!-- NOVEL VIEW -->
  <div id="view-novel" class="hidden">
    <section class="about" style="padding:40px 0 10px"><div class="container"><h1 style="font-family:'Playfair Display',serif;margin:0">Novel</h1><p style="color:var(--muted)">Kumpulan bab, outline, dan catatan riset novel.</p></div></section>
    <div class="toolbar" aria-label="Pencarian"><div class="container toolbar-inner"><label class="visually-hidden" for="search-novel">Cari postingan novel</label><div class="search"><input id="search-novel" type="search" placeholder="Cari di Novel…" autocomplete="off"/><div class="kbd">/</div></div></div></div>
    <main class="section container" aria-live="polite"><div class="grid" id="grid-novel"></div><div class="pager" id="pager-novel"></div></main>
  </div>

  <!-- ABOUT VIEW -->
  <div id="view-about" class="hidden">
    <section class="about"><div class="container about-grid"><div class="avatar"><img src="rafyaboutprofile.jpg" alt="Foto Rafy"></div><div><h1 style="font-family:'Playfair Display',serif;font-size:40px;margin:0 0 8px">Tentang Penulis</h1><p style="color:var(--muted);line-height:1.8">Hai! Aku <strong>Rafy Rayyan</strong>, siswa kelas 12 SMAN 68 Jakarta. Aku suka menulis fiksi, ngoprek web, dan bikin proyek kreatif. Blog ini jadi arsip perjalanan nulis novel untuk tugas akhir Bahasa Indonesia—plus tempatku berbagi catatan, ide, dan hal-hal yang menurutku seru.</p><div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px"><a class="btn" href="https://www.instagram.com/rafy.rayyan/" target="_blank" rel="noopener">📷 Instagram</a><a class="btn" href="#" title="Email (isi nanti)">✉️ Email</a></div></div></div></section>
    <section class="container" style="margin-bottom:50px"><div class="card" style="padding:18px"><h2 style="margin:0 0 8px">Ringkas</h2><ul style="line-height:1.8;margin:0;padding-left:18px"><li>Sekolah: SMAN 68 Jakarta (Kelas 12)</li><li>Minat: penulisan kreatif, desain web, komunitas sekolah</li><li>Novel yang sedang digarap: <em>(judul sementara)</em></li></ul></div></section>
  </div>

  <!-- POST VIEW -->
  <div id="view-post" class="hidden">
    <header class="post"><div class="container"><h1 id="postTitle" class="post-title">Judul</h1><div id="postMeta" class="post-meta">Tanggal • Tag</div><div id="postHero" class="post-hero hidden"><img alt=""></div></div></header>
    <main class="container">
      <article id="postBody"></article>

      <!-- REACTIONS (static container) -->
      <div class="react-row" id="reactRow" aria-label="Reaksi pembaca"></div>

      <nav class="post-nav"><a id="prevPost" class="btn" href="#">← Sebelumnya</a><a id="nextPost" class="btn" href="#">Berikutnya →</a></nav>

      <!-- KOMENTAR -->
      <section id="comments" style="margin:26px 0 60px">
        <h2>Komentar</h2>
        <div id="cAuth" style="margin:8px 0"></div>
        <div class="card" style="padding:12px">
          <div class="cform" id="cForm">
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
              <input id="cName" placeholder="Nama (otomatis dari Google, bisa diganti)" autocomplete="name" />
              <input id="cAvatar" placeholder="URL foto profil (opsional)" autocomplete="url" />
            </div>
            <textarea id="cText" placeholder="Tulis komentar…" rows="3"></textarea>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button class="btn" id="cClear" type="button">Bersihkan</button>
              <button class="btn primary" id="cSend" type="button">Kirim</button>
            </div>
          </div>
        </div>
        <div id="cList"></div>
      </section>
    </main>
  </div>

  <!-- FOOTER -->
  <footer class="site-footer"><div class="container foot-grid"><div><div class="foot-brand"><div class="brand-badge" aria-hidden="true"></div><div><div style="font-weight:800">Rafy Rayyan</div><div class="desc">Blog ini mendokumentasikan perjalanan menulis novel dan belajar hal-hal kreatif lainnya. Terima kasih sudah mampir dan membaca. 🙌</div><div class="foot-social"><a class="iconbtn" href="https://www.instagram.com/rafy.rayyan/" target="_blank" rel="noopener" title="Instagram">IG</a></div></div></div></div><div><div style="font-weight:700;margin-bottom:8px">Stat singkat</div><div class="stat"><div class="box"><div style="font-size:28px;font-weight:800" id="statPosts">0</div><div style="font-size:12px;color:var(--muted)">Total Post</div></div><div class="box"><div style="font-size:28px;font-weight:800" id="statTags">0</div><div style="font-size:12px;color:var(--muted)">Jumlah Tag</div></div></div></div><div><div style="font-weight:700;margin-bottom:8px">Catatan kecil</div><div class="quote">“Menulis itu merawat ingatan. Setiap paragraf adalah jejak yang tidak ingin hilang.”</div></div></div><div class="container copy"><span>© 2025 — Dibuat oleh <a href="https://www.instagram.com/rafy.rayyan/" target="_blank" rel="noopener">Rafy Rayyan</a>. Semua konten dilindungi hak cipta.</span><button class="btn" id="toTop" type="button">Kembali ke atas</button></div></footer>

  <!-- SUBSCRIBE MODAL -->
  <div id="subModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="subTitle">
    <div class="modal-backdrop"></div>
    <div class="modal-card">
      <h3 id="subTitle">Berlangganan via Email</h3>
      <p id="subNotice" style="color:var(--muted);margin-top:2px">Masukkan email untuk mendapat kabar saat ada tulisan baru.</p>
      <input type="email" id="subEmail" placeholder="nama@contoh.com" autocomplete="email" />
      <div class="modal-actions"><button class="btn" id="subCancel">Batal</button><button class="btn primary" id="subSave">Simpan</button></div>
      <button class="toggle" id="closeSub" style="position:absolute;right:10px;top:10px">✕</button>
    </div>
  </div>

  <!-- PAGE LOADER + BGM -->
  <div id="page-loader" class="loader" aria-hidden="true"><div class="spinner" role="status" aria-label="Memuat"></div></div>
  <audio id="bgm" loop preload="auto"></audio>
  <button id="bgmToggle" class="bgm-btn" aria-pressed="false" title="Musik latar"><span class="bgm-ico" aria-hidden="true">🔇</span><span class="visually-hidden">Toggle musik latar</span></button>

  <!-- SINGLE MODULE SCRIPT (semua JS digabung) -->
  <script type="module">
  /* ===============================
     Firebase SDK (Auth + Firestore)
     =============================== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import {
    getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, deleteDoc,
    query, orderBy, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDXQygwS9MCOwnHPxwg6oSfczsp51S-n9o",
    authDomain: "rafyermadi-d0eef.firebaseapp.com",
    projectId: "rafyermadi-d0eef",
    storageBucket: "rafyermadi-d0eef.firebasestorage.app",
    messagingSenderId: "200873624449",
    appId: "1:200873624449:web:6a96fa29f37deca10f9e80"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const provider = new GoogleAuthProvider();

  /* ==============
     Utils & Theme
     ============== */
  const $  = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
  const root = document.documentElement;
  const setTheme = (t)=>{
    root.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
    const ic = $('#themeIcon');
    if (ic){ ic.textContent = t==='light' ? '☀️' : '🌙'; ic.style.transition='transform .45s var(--ease)'; ic.style.transform = t==='light' ? 'rotate(-180deg) scale(1.1)' : 'rotate(0deg)'; }
    $('#themeToggle')?.setAttribute('aria-pressed', t==='dark' ? 'true':'false');
  };
  const savedTheme = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
  setTheme(savedTheme);
  $('#themeToggle')?.addEventListener('click', ()=> setTheme(root.getAttribute('data-theme')==='dark'?'light':'dark'));

  const monthID = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  const fmtDate = (iso) => { const d = new Date(iso + 'T00:00:00'); return `${d.getDate()} ${monthID[d.getMonth()]} ${d.getFullYear()}`; };
  const showLoader = ()=> $('#page-loader')?.classList.add('show');
  const hideLoader = ()=> $('#page-loader')?.classList.remove('show');

  /* =========
     Demo data
     ========= */
  const posts = [
    { id:'novel-bab-1', title:'Novel — Bab 1: Pagi yang Menggantung', date:'2025-08-20', tags:['Novel','Progres','Bab 1'], image:'https://images.unsplash.com/photo-1507842217343-583bb7270b66?q=80&w=1200&auto=format&fit=crop', excerpt:'Awal cerita—sebuah pagi di Jakarta, ketika segalanya terasa biasa saja, sampai tidak lagi…', body:`<p>Pagi di Jakarta selalu terdengar sama: klakson, pedagang roti, dan radio tetangga yang tak pernah tepat frekuensi. Aku berjalan menembus lorong kos yang sempit sambil menghitung napas.</p><p>Di halaman, ada sandal yang ditinggalkan tergesa. "Pertanda baik atau buruk?" batinku. Telepon bergetar—pesan dari Ibu, hanya satu kata: <em>Pulang.</em></p><h2>Set up konflik</h2><p>Bab ini memperkenalkan dua hal: hilangnya figur jangkar dan kota yang ikut menelan suara.</p>`},
    { id:'catatan-riset', title:'Catatan Riset: Menentukan Setting & Perspektif', date:'2025-08-18', tags:['Novel','Catatan','Riset'], image:'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop', excerpt:'Kenapa memilih sudut pandang orang pertama? Plus daftar referensi yang kupakai.', body:`<p>Aku membandingkan POV orang pertama vs orang ketiga terbatas. Pilihan jatuh ke orang pertama untuk menangkap kegelisahan tokoh secara dekat.</p><blockquote>Satu kota bisa menjadi tokoh, jika kita memberinya napas.</blockquote><p>Referensi: <em>Norwegian Wood</em>, <em>Lelaki Harimau</em>, dan esai dialog.</p>`},
    { id:'teknik-dialog', title:'Teknik Dialog: Biar Ngobrolnya Hidup', date:'2025-08-16', tags:['Tips Menulis','Workshop','Blog'], image:'https://images.unsplash.com/photo-1515516969-d4008cc6241a?q=80&w=1200&auto=format&fit=crop', excerpt:'Beberapa trik sederhana untuk bikin dialog terasa alami tanpa “ceramah”.', body:`<p>Trik cepat: kurangi penjelasan setelah dialog, biarkan respon lawan bicara memikul makna.</p><ul><li>Gunakan jeda seperlunya.</li><li>Gesture kecil menandai emosi.</li><li>Seimbangkan “kataku, katanya” dengan aksi.</li></ul>`},
    { id:'novel-outline', title:'Outline Kasar: Alur Besar Novel', date:'2025-08-14', tags:['Novel','Outline','Progres'], image:'https://images.unsplash.com/photo-1491841550275-ad7854e35ca6?q=80&w=1200&auto=format&fit=crop', excerpt:'Kerangka 3 babak + benang merah konflik utama dan subplot keluarga.', body:`<p>Struktur 3 babak: pengenalan — eskalasi — resolusi. Subplot keluarga menempel pada pilihan kuliah tokoh.</p>`},
    { id:'random-thoughts', title:'Random Thoughts: Nulis di Tengah Deadline', date:'2025-08-12', tags:['Blog','Opini','Produktivitas'], image:'https://images.unsplash.com/photo-1516542076529-1ea3854896e1?q=80&w=1200&auto=format&fit=crop', excerpt:'Cara bagiku menjaga ritme nulis tanpa ngorbanin sekolah.', body:`<p>Strategi: nulis 25 menit, rehat 5 menit—ulang 3 kali. Satu sesi ≈ 1 halaman.</p>`},
    { id:'novel-bab-2', title:'Novel — Bab 2: Peta yang Hilang', date:'2025-08-10', tags:['Novel','Progres','Bab 2'], image:'https://images.unsplash.com/photo-1455390582262-044cdead277a?q=80&w=1200&auto=format&fit=crop', excerpt:'Tokoh menemukan peta usang yang menuntun ke masa lalu ayahnya.', body:`<p>Peta jadi pemicu babak dua.</p>`},
    { id:'tips-outline', title:'Tips Outline yang Nggak Bikin Pusing', date:'2025-08-08', tags:['Blog','Tips Menulis'], image:'https://images.unsplash.com/photo-1524578271613-d550eacf6090?q=80&w=1200&auto=format&fit=crop', excerpt:'Cara cepat bikin outline versi “kabel rapi”.', body:`<p>Pakai pola 3 babak, tulis konflik per babak dalam 1 kalimat.</p>`},
    { id:'novel-riset-lokasi', title:'Riset Lokasi: Catatan Lapangan', date:'2025-08-06', tags:['Novel','Riset'], image:'https://images.unsplash.com/photo-1456425712190-0dd8c2b00156?q=80&w=1200&auto=format&fit=crop', excerpt:'Rute bus, suara pasar pagi, dan aroma hujan—semua dicatat.', body:`<p>Merekam detail sensorik untuk adegan.</p>`},
    { id:'esai-favorit', title:'Esai Favorit tentang Penokohan', date:'2025-08-04', tags:['Blog','Opini'], image:'https://images.unsplash.com/photo-1455390582262-044cdead277a?q=80&w=1200&auto=format&fit=crop', excerpt:'Kumpulan esai yang bikin mikir ulang cara membangun karakter.', body:`<p>Daftar esai dan ringkasannya.</p>`},
    { id:'novel-bab-3', title:'Novel — Bab 3: Telepon Tengah Malam', date:'2025-08-02', tags:['Novel','Progres','Bab 3'], image:'https://images.unsplash.com/photo-1497250681960-ef046c08a56e?q=80&w=1200&auto=format&fit=crop', excerpt:'Sebuah telepon mengubah keputusan tokoh.', body:`<p>Twist pertama muncul.</p>`},
    { id:'catatan-gaya', title:'Catatan Gaya: Metafora yang Hemat', date:'2025-07-30', tags:['Blog','Catatan'], image:'https://images.unsplash.com/photo-1526318472351-c75fcf070305?q=80&w=1200&auto=format&fit=crop', excerpt:'Menjaga metafora tetap jernih dan tepat sasaran.', body:`<p>Contoh sebelum–sesudah.</p>`},
    { id:'review-buku', title:'Review Buku: Cara Menulis Dialog', date:'2025-07-28', tags:['Blog','Review'], image:'https://images.unsplash.com/photo-1544930834-45e1b225b0cc?q=80&w=1200&auto=format&fit=crop', excerpt:'Catatan dari buku craft writing favorit.', body:`<p>Tiga poin yang bisa langsung dipraktikkan.</p>`},
    { id:'novel-bab-4', title:'Novel — Bab 4: Hujan di Peron', date:'2025-07-26', tags:['Novel','Progres','Bab 4'], image:'https://images.unsplash.com/photo-1444723121867-7a241cacace9?q=80&w=1200&auto=format&fit=crop', excerpt:'Adegan peron jadi titik balik relasi.', body:`<p>Adegan dialog singkat namun tajam.</p>`},
  ];

  /* =================
     Search & Listing
     ================= */
  const states = { home:{q:'', page:1}, blog:{q:'', page:1}, novel:{q:'', page:1} };
  const norm = (s)=> (s||'').toLowerCase().replace(/<[^>]+>/g,' ');
  function searchFilter(list, q){
    const tokens = q.trim()? q.trim().toLowerCase().split(/\s+/):[];
    let res = list;
    if(tokens.length){
      res = res.filter(p=>{
        const hay = norm(p.title+' '+p.excerpt+' '+p.tags.join(' ')+' '+p.body);
        return tokens.every(t=> hay.includes(t));
      });
    }
    return res.sort((a,b)=> new Date(b.date)-new Date(a.date));
  }
  function cardHTML(p){
    return `
      <a class="card-link" href="/post/${encodeURIComponent(p.id)}" aria-label="Buka: ${p.title}">
        <article class="card will-reveal">
          <div class="thumb">${p.image?`<img src="${p.image}" alt="Thumbnail untuk: ${p.title}">`:''}</div>
          <div class="card-body">
            <div class="meta"><span>${fmtDate(p.date)}</span> • <span>${p.tags[0]}</span></div>
            <h3 class="title">${p.title}</h3>
            <p>${p.excerpt}</p>
            <div class="tags">${p.tags.map(t => `<span class="tag">#${t}</span>`).join('')}</div>
          </div>
        </article>
      </a>`;
  }
  const revealObs = new IntersectionObserver((entries)=>entries.forEach(en=>{
    if(en.isIntersecting){ en.target.classList.add('reveal-in'); revealObs.unobserve(en.target); }
  }), {rootMargin:'0px 0px -10% 0px', threshold:0.1});
  function attachReveal(scope){ $$('.will-reveal', scope||document).forEach(el=> revealObs.observe(el)); }
  function renderGrid(gridEl, list){
    const fallback = `<div style="grid-column:1/-1;padding:26px;border:1px dashed rgba(255,255,255,.18);border-radius:14px;text-align:center;color:var(--muted)">Tidak ada hasil yang cocok.</div>`;
    gridEl.innerHTML = list.length ? list.map(cardHTML).join('') : fallback;
    attachReveal(gridEl);
    $$('.thumb', gridEl).forEach(t=>{
      t.classList.add('skeleton');
      const img = t.querySelector('img');
      if(img){
        img.setAttribute('loading','lazy');
        img.addEventListener('load', ()=> t.classList.remove('skeleton'), {once:true});
        img.addEventListener('error', ()=> t.classList.remove('skeleton'), {once:true});
      } else t.classList.remove('skeleton');
    });
  }
  function setupSearch(view){
    const S = states[view];
    const input = document.getElementById(`search-${view}`);
    if(!input || input.dataset.inited) return;
    input.dataset.inited = '1';
    window.addEventListener('keydown',(e)=>{
      if($('#view-'+view).classList.contains('hidden')) return;
      if(e.key==='/' && document.activeElement!==input){ e.preventDefault(); input.focus(); }
    });
    input.addEventListener('input', e=>{ S.q = e.target.value; S.page = 1; routeRender(); });
  }
  const perPageForViewport = ()=> (innerWidth < 640 ? 8 : (innerWidth <= 1024 ? 8 : 12));
  function renderPager(view, totalPages){
    const wrap = document.getElementById(`pager-${view}`); if(!wrap) return;
    const cur = states[view].page;
    if(totalPages <= 1){ wrap.innerHTML = ''; return; }
    const nums = [];
    const push = n => nums.push(`<button class="btn ${n===cur?'active':''}" data-p="${n}">${n}</button>`);
    const addDots = ()=> nums.push(`<span style="padding:8px 6px;color:var(--muted)">…</span>`);
    push(1);
    if(cur > 3) addDots();
    for(let n=Math.max(2,cur-1); n<=Math.min(totalPages-1,cur+1); n++) push(n);
    if(cur < totalPages-2) addDots();
    if(totalPages>1) push(totalPages);
    wrap.innerHTML = `
      <button class="btn" data-p="prev" ${cur===1?'disabled':''}>←</button>
      ${nums.join('')}
      <button class="btn" data-p="next" ${cur===totalPages?'disabled':''}>→</button>`;
    wrap.onclick = (e)=>{
      const p = e.target.getAttribute('data-p'); if(!p) return;
      if(p==='prev' && states[view].page>1) states[view].page--;
      else if(p==='next' && states[view].page<totalPages) states[view].page++;
      else if(/^\d+$/.test(p)) states[view].page = parseInt(p,10);
      routeRender(); window.scrollTo({ top: 0, behavior: 'smooth' });
    };
  }

  /* ==========
     Post view
     ========== */
  function renderHome(){ setupSearch('home'); const filtered = searchFilter(posts.slice(), states.home.q); const per = perPageForViewport(); const total = Math.max(1, Math.ceil(filtered.length / per)); states.home.page = Math.min(Math.max(1, states.home.page), total); const start = (states.home.page-1)*per; renderGrid($('#grid-home'), filtered.slice(start, start+per)); renderPager('home', total); }
  function renderBlog(){ setupSearch('blog'); const base = posts.filter(p=> p.tags.includes('Blog')); const filtered = searchFilter(base, states.blog.q); const per = perPageForViewport(); const total = Math.max(1, Math.ceil(filtered.length / per)); states.blog.page = Math.min(Math.max(1, states.blog.page), total); const start = (states.blog.page-1)*per; renderGrid($('#grid-blog'), filtered.slice(start, start+per)); renderPager('blog', total); }
  function renderNovel(){ setupSearch('novel'); const base = posts.filter(p=> p.tags.includes('Novel')); const filtered = searchFilter(base, states.novel.q); const per = perPageForViewport(); const total = Math.max(1, Math.ceil(filtered.length / per)); states.novel.page = Math.min(Math.max(1, states.novel.page), total); const start = (states.novel.page-1)*per; renderGrid($('#grid-novel'), filtered.slice(start, start+per)); renderPager('novel', total); }

  function renderPost(id){
    const idx  = posts.findIndex(p => p.id === id);
    const post = posts[idx] || posts[0];

    document.title = `${post.title} — Rafy Rayyan`;
    $('#postTitle').textContent = post.title;
    $('#postMeta').textContent  = `${fmtDate(post.date)} • ${post.tags.join(', ')}`;

    const hero = $('#postHero');
    if (post.image){
      hero.classList.remove('hidden');
      const img = hero.firstElementChild;
      img.src = post.image;
      img.alt = 'Gambar: ' + post.title;
    } else hero.classList.add('hidden');

    $('#postBody').innerHTML = post.body;

    const prev  = posts[idx-1] || null;
    const next  = posts[idx+1] || null;
    const prevA = $('#prevPost');
    const nextA = $('#nextPost');

    if (prev){ prevA.href = `/post/${prev.id}`; prevA.textContent = '← ' + prev.title; prevA.style.visibility='visible'; } else prevA.style.visibility='hidden';
    if (next){ nextA.href = `/post/${next.id}`; nextA.textContent = next.title + ' →'; nextA.style.visibility='visible'; } else nextA.style.visibility='hidden';

    // simpan id post aktif; panggil kalau modul Firebase sudah siap
    window.__currentPostId = post.id;
    if (window.initPostFeatures) window.initPostFeatures(post.id);
    else window.__deferredPF = post.id;
  }

  /* =========
     Navbar & Router (History API)
     ========= */
  function currentPath(){
    let p = location.pathname;
    if (!p) return '/';
    // hapus trailing slash (kecuali root)
    if (p.length>1) p = p.replace(/\/+$/, '');
    return p;
  }
  function setActive(p){
    $$('.menu a').forEach(a=>{
      const k=a.dataset.link;
      const on = (k==='home' && (p==='/'||p===''))
              || (k==='about' && p.startsWith('/about'))
              || (k==='blog'  && p.startsWith('/blog'))
              || (k==='novel' && p.startsWith('/novel'));
      a.classList.toggle('active', on);
    });
  }
  function show(view){
    $('#view-home') ?.classList.toggle('hidden', view!=='home');
    $('#view-about')?.classList.toggle('hidden', view!=='about');
    $('#view-post') ?.classList.toggle('hidden', view!=='post');
    $('#view-blog') ?.classList.toggle('hidden', view!=='blog');
    $('#view-novel')?.classList.toggle('hidden', view!=='novel');
    window.scrollTo({top:0, behavior:'auto'});
  }
  function onScrollNav(){ document.querySelector('.nav')?.classList.toggle('scrolled', window.scrollY>4); }
  window.addEventListener('scroll', onScrollNav);

  function prepareReveal(){
    ['.hero .avatar', '.hero h1', '.hero p', '.hero .hero-cta', '.about .avatar', '.about .card', '.foot-grid > *']
      .forEach(sel=> $$(sel).forEach(el=>{ if(!el.classList.contains('will-reveal')) el.classList.add('will-reveal'); }));
    attachReveal(document);
  }

  function routeRender(){
    const p = currentPath();
    setActive(p);
    showLoader();
    const finish = ()=>{ prepareReveal(); setTimeout(hideLoader, 200); setTimeout(hideLoader, 1500); onScrollNav(); };

    try {
      if(p.startsWith('/post/')){ show('post'); renderPost(decodeURIComponent(p.replace('/post/',''))); }
      else if (p==='/about'){ show('about'); }
      else if (p==='/blog'){ show('blog'); renderBlog(); }
      else if (p==='/novel'){ show('novel'); renderNovel(); }
      else { show('home'); renderHome(); }
    } catch (e) { console.error(e); }
    finally { finish(); }
  }

  // Intersep klik link internal agar tidak reload (History API)
  function navigate(to, {replace=false}={}){
    const url = new URL(to, location.origin);
    if (url.origin !== location.origin) { location.href = url.href; return; }
    const path = url.pathname + url.search; // abaikan hash untuk SPA
    if(replace) history.replaceState({}, '', path); else history.pushState({}, '', path);
    routeRender();
  }
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a[href]');
    if(!a) return;
    const href = a.getAttribute('href');
    if(!href) return;
    // biarkan anchor fragment (#...), download, target _blank, dan eksternal
    if (href.startsWith('#') || a.hasAttribute('download') || (a.target && a.target!=='') ) return;
    const url = new URL(a.href, location.origin);
    if (url.origin !== location.origin) return; // eksternal
    e.preventDefault();
    navigate(url.pathname + url.search);
  });
  window.addEventListener('popstate', routeRender);
  let rszT; window.addEventListener('resize', ()=>{ clearTimeout(rszT); rszT = setTimeout(routeRender, 120); });

  /* ===========================
     Background Music (ringkas)
     =========================== */
  (function(){
    const MUSIC_SRC = new URLSearchParams(location.search).get('music') || 'bgm.mp3';
    const bgm = document.getElementById('bgm');
    const bgmBtn = document.getElementById('bgmToggle');
    if(!bgm || !bgmBtn) return;

    const ico = bgmBtn.querySelector('.bgm-ico');
    bgm.src = MUSIC_SRC; bgm.loop = true; bgm.preload = 'auto';
    try{ const vol = parseFloat(localStorage.getItem('bgmVol')||'0.7'); if(!Number.isNaN(vol)) bgm.volume = Math.min(1, Math.max(0, vol)); }catch(_){ }

    function updateUI(){
      const playing = !bgm.paused && !bgm.ended;
      bgmBtn.classList.toggle('playing', playing);
      bgmBtn.setAttribute('aria-pressed', playing? 'true':'false');
      if(ico) ico.textContent = playing? '🔊':'🔇';
    }
    async function playIfAllowed(){
      try{ await bgm.play(); localStorage.setItem('bgm','on'); } catch(e){ localStorage.setItem('bgm','off'); } finally{ updateUI(); }
    }
    if(localStorage.getItem('bgm')==='on') playIfAllowed(); else updateUI();
    bgmBtn.addEventListener('click', async ()=>{ if(bgm.paused){ await playIfAllowed(); } else { bgm.pause(); localStorage.setItem('bgm','off'); updateUI(); } });
    document.addEventListener('pointerdown', function once(){ if(localStorage.getItem('bgm')==='on' && bgm.paused){ playIfAllowed(); } document.removeEventListener('pointerdown', once); }, {capture:false});
    window.addEventListener('popstate', ()=>{ if(localStorage.getItem('bgm')==='on' && bgm.paused){ playIfAllowed(); } });
  })();

  /* ==========================================
     Firebase-driven: Reaction & Comment System
     ========================================== */
  let __postUnsub = null;            // listener komentar
  let __countsBusy = false;          // throttle hitung reaction
  let __reactBusy  = false;          // cegah spam klik
  let __currentPostId = null;        // id post aktif
  const REACT_KEYS = ['like','love','fire','clap','wow']; // 👍❤️🔥👏😯

  /* Auth UI di area komentar */
  function mountAuthControls(where) {
    if (!where) return;
    let wrap = $('#authCtrl', where);
    if (!wrap) {
      wrap = document.createElement('div');
      wrap.id = 'authCtrl';
      wrap.style.display='flex';
      wrap.style.alignItems='center';
      wrap.style.gap='8px';
      wrap.style.margin='0 0 10px';
      where.prepend(wrap);
    }
    const u = auth.currentUser;
    if (!u) {
      wrap.innerHTML = `
        <button id="gLogin" class="btn" type="button">Masuk dengan Google</button>
        <span style="color:var(--muted)">Wajib login untuk komentar & reaction</span>
      `;
      $('#gLogin',wrap)?.addEventListener('click', async()=>{
        try{ await signInWithPopup(auth, provider); }catch(e){ console.error(e); }
      }, {once:true});
    } else {
      wrap.innerHTML = `
        <img src="${u.photoURL||''}" alt="" style="width:28px;height:28px;border-radius:50%">
        <span style="font-weight:600">${u.displayName||u.email||'Pengguna'}</span>
        <button id="gLogout" class="btn" type="button">Keluar</button>
      `;
      $('#gLogout',wrap)?.addEventListener('click', ()=> signOut(auth), {once:true});
    }
  }

  /* Row reaction — boleh dilihat tanpa login */
  function buildReactRow(container) {
    if (!container) return;
    container.innerHTML = `
      ${[['like','👍'],['love','❤️'],['fire','🔥'],['clap','👏'],['wow','😯']]
        .map(([k,emo])=>`
          <button class="btn react" data-k="${k}" aria-pressed="false"
            style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04)">
            <span class="emo">${emo}</span>
            <span class="cnt" data-for="${k}">0</span>
          </button>`).join('')}
    `;
    if (!container.dataset.bound) {
      container.addEventListener('click', async(e)=>{
        const btn = e.target.closest('button.react'); if(!btn) return;
        const k = btn.dataset.k;
        await toggleReaction(k);
      });
      container.dataset.bound = '1';
    }
  }

  async function refreshCounts() {
    if (__countsBusy || !__currentPostId) return;
    __countsBusy = true;
    try {
      const snap = await getDocs(collection(db, `posts/${__currentPostId}/reactions`));
      const sums = {like:0,love:0,fire:0,clap:0,wow:0};
      snap.forEach(d=>{
        const v = d.data();
        REACT_KEYS.forEach(k=>{ if (v[k]) sums[k]++; });
      });
      REACT_KEYS.forEach(k=>{
        const el = $(`.cnt[data-for="${k}"]`);
        if (el) el.textContent = String(sums[k]||0);
      });
      // highlight milik user
      const u = auth.currentUser;
      if (u) {
        const my = await getDoc(doc(db, `posts/${__currentPostId}/reactions/${u.uid}`));
        const data = my.exists() ? my.data() : {};
        $$('#reactRow button.react').forEach(b=>{
          const on = !!data[b.dataset.k];
          b.setAttribute('aria-pressed', on?'true':'false');
          b.style.outline = on? '2px solid var(--brand-2)':'none';
        });
      } else {
        $$('#reactRow button.react').forEach(b=>{
          b.setAttribute('aria-pressed','false');
          b.style.outline='none';
        });
      }
    } catch(e){ console.error(e); }
    finally { __countsBusy = false; }
  }

  async function toggleReaction(key) {
    if (__reactBusy) return;
    const u = auth.currentUser;
    if (!u) { alert('Masuk dulu untuk memberi reaction.'); return; }
    __reactBusy = true;
    try{
      const ref = doc(db, `posts/${__currentPostId}/reactions/${u.uid}`);
      // status target
      let wantOn = true;
      const btn = $(`#reactRow button.react[data-k="${key}"]`);
      if (btn) wantOn = btn.getAttribute('aria-pressed') !== 'true';
      else {
        const snap = await getDoc(ref);
        wantOn = !(snap.exists() && !!snap.data()[key]);
      }
      await setDoc(ref, {
        uid: u.uid, postId: __currentPostId,
        [key]: wantOn,
        updatedAt: serverTimestamp(),
        createdAt: serverTimestamp()
      }, {merge:true});

      // jika semua off -> hapus dokumen
      const after = await getDoc(ref);
      const d = after.data()||{};
      const anyOn = REACT_KEYS.some(k=> !!d[k]);
      if (!anyOn) await deleteDoc(ref).catch(()=>{});

      await refreshCounts();
    }catch(err){ console.error(err); alert('Gagal menyimpan reaction.'); }
    finally{ __reactBusy = false; }
  }

  /* UI komentar */
  function buildCommentUI(container){
    if (!container) return;
    container.querySelector('#cAuth') && mountAuthControls(container.querySelector('#cAuth'));

    // bind form (hindari duplikasi)
    const sendBtn = container.querySelector('#cSend');
    if (sendBtn && !sendBtn.dataset.bound) {
      sendBtn.dataset.bound = '1';
      sendBtn.addEventListener('click', onSendComment);
    }
    const clearBtn = container.querySelector('#cClear');
    clearBtn?.addEventListener('click', ()=>{ container.querySelector('#cText').value=''; });
  }

  async function onSendComment(){
    const u = await ensureUser(); if (!u) return;
    const wrap = $('#comments');
    const name   = $('#cName',wrap)?.value.trim()   || u.displayName || 'Anon';
    const avatar = $('#cAvatar',wrap)?.value.trim() || u.photoURL || '';
    const textEl = $('#cText',wrap);
    const text   = (textEl.value||'').trim();
    if (!text) return;

    const btn = $('#cSend',wrap);
    btn.disabled = true; btn.textContent = 'Mengirim…';
    try{
      await addDoc(collection(db, `posts/${__currentPostId}/comments`), {
        uid: u.uid, postId: __currentPostId, name, avatar, text, createdAt: serverTimestamp()
      });
      textEl.value = '';
    }catch(err){ console.error(err); alert('Gagal mengirim komentar.'); }
    finally{ btn.disabled = false; btn.textContent = 'Kirim'; }
  }

  async function ensureUser(){
    if (auth.currentUser) return auth.currentUser;
    try{ await signInWithPopup(auth, provider); return auth.currentUser; }
    catch(e){ console.error(e); return null; }
  }

  function mountCommentList(container){
    if (__postUnsub) { __postUnsub(); __postUnsub = null; }
    const list = container.querySelector('#cList');
    if (!list) return;
    list.innerHTML = '';
    const qy = query(collection(db, `posts/${__currentPostId}/comments`), orderBy('createdAt','desc'));
    __postUnsub = onSnapshot(qy, (snap)=>{
      list.innerHTML = '';
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        const el = document.createElement('div');
        el.className = 'card comment-card';
        el.style.padding='12px';
        el.innerHTML = `
          <div style="display:flex;align-items:center;gap:8px;color:var(--muted);font-size:12px">
            <img src="${d.avatar||''}" alt="" style="width:20px;height:20px;border-radius:50%">
            <strong style="font-size:13px;color:var(--text)">${d.name||'Anon'}</strong>
            <span>•</span>
            <span>${d.createdAt?.toDate?.()?.toLocaleString?.()||''}</span>
          </div>
          <div style="margin-top:6px;white-space:pre-wrap">${(d.text||'')}</div>
        `;
        list.appendChild(el);
      });
    }, (err)=> console.error(err));
  }

  /* Inisialisasi fitur post (dipanggil dari renderPost) */
  async function initPostFeatures(postId){
    __currentPostId = postId;

    // Reaction row (pakai container statis di HTML)
    const reactMount = document.getElementById('reactRow');
    if (reactMount) {
      reactMount.innerHTML = '';
      buildReactRow(reactMount);
      await refreshCounts();
    }

    // Komentar
    const com = document.getElementById('comments');
    if (com) {
      buildCommentUI(com);
      mountCommentList(com);
    }
  }
  window.initPostFeatures = initPostFeatures;
  if (window.__deferredPF) { initPostFeatures(window.__deferredPF); window.__deferredPF = null; }

  /* Update UI saat status login berubah */
  onAuthStateChanged(auth, ()=>{
    const com = $('#comments');
    if (com) mountAuthControls($('#cAuth', com));
    refreshCounts(); // untuk highlight tombol + jumlah
    console.log('auth changed', auth.currentUser ? auth.currentUser.uid : null);
  });

  /* =============
     Boot & start
     ============= */
  (function bootSplash(){
    const l1 = document.getElementById('loader');
    const l2 = document.getElementById('page-loader');
    const min = 300;
    const start = performance.now();
    if (l2) l2.classList.add('show');
    requestAnimationFrame(()=>{
      const wait = Math.max(0, min - (performance.now() - start));
      setTimeout(()=> { l2?.classList.remove('show'); l1?.classList.add('hidden'); }, wait);
    });
  })();

  // footer stats & first render
  $('#statPosts').textContent = posts.length; $('#statTags').textContent = new Set(posts.flatMap(p=>p.tags)).size;
  $('#toTop')?.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
  // subscribe modal
  function openSub(){ const m=$('#subModal'); if(m){ m.classList.remove('hidden'); $('#subEmail')?.focus(); document.body.style.overflow='hidden'; }}
  function closeSub(){ $('#subModal')?.classList.add('hidden'); document.body.style.overflow=''; }
  $('#openSub')?.addEventListener('click', openSub); $('#closeSub')?.addEventListener('click', closeSub); $('#subCancel')?.addEventListener('click', closeSub);
  $('#subSave')?.addEventListener('click', ()=>{ const email = ($('#subEmail')?.value||'').trim(); const valid = /[^@\s]+@[^@\s]+\.[^@\s]+/.test(email); const notice = $('#subNotice'); if(!valid){ notice.textContent='Email tidak valid.'; notice.style.color='salmon'; return; } const key='subscribers'; const arr = JSON.parse(localStorage.getItem(key)||'[]'); if(!arr.includes(email)) arr.push(email); localStorage.setItem(key, JSON.stringify(arr)); notice.textContent='Berhasil! Email tersimpan di perangkat ini. Integrasi pengiriman bisa ditambahkan nanti.'; notice.style.color='var(--muted)'; setTimeout(closeSub, 900); });
  $('#subModal')?.addEventListener('click', (e)=>{ if(e.target.id==='subModal' || e.target.classList.contains('modal-backdrop')) closeSub(); });

  routeRender(); // first render
  </script>
</body>
</html>

